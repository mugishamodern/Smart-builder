{% extends "base.html" %}

{% block title %}Chat with {{ other_user.full_name or other_user.username }} - BuildSmart{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <!-- Chat Header -->
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <a href="{{ url_for('messaging.inbox') }}" class="btn btn-sm btn-outline-secondary me-3">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                        <div class="avatar-circle me-3">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">
                                {{ other_user.full_name or other_user.username }}
                                {% if other_user.user_type == 'shop_owner' %}
                                    <span class="badge bg-info ms-2">Shop</span>
                                {% elif other_user.user_type == 'admin' %}
                                    <span class="badge bg-danger ms-2">Admin</span>
                                {% endif %}
                            </h5>
                            <small class="text-muted" id="typing-indicator" style="display: none;">typing...</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="card shadow-sm" style="height: 600px; display: flex; flex-direction: column;">
                <div class="card-body flex-grow-1 overflow-auto" id="messages-container" style="background-color: #f8f9fa;">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="message-wrapper mb-3 {% if message.sender_id == current_user.id %}text-end{% endif %}">
                                <div class="message-bubble d-inline-block p-3 rounded-3 {% if message.sender_id == current_user.id %}bg-primary text-white{% else %}bg-white border{% endif %}" 
                                     style="max-width: 70%;">
                                    <p class="mb-1">{{ message.content }}</p>
                                    <small class="opacity-75">
                                        {{ message.timestamp.strftime('%I:%M %p') }}
                                        {% if message.sender_id == current_user.id %}
                                            {% if message.is_read %}
                                                <i class="fas fa-check-double text-info"></i>
                                            {% else %}
                                                <i class="fas fa-check"></i>
                                            {% endif %}
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Message Input -->
                <div class="card-footer bg-white">
                    <form id="message-form" class="d-flex gap-2">
                        <input type="text" 
                               class="form-control" 
                               id="message-input" 
                               placeholder="Type your message..." 
                               autocomplete="off"
                               required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-yellow), var(--accent-orange));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.message-bubble {
    word-wrap: break-word;
    text-align: left;
}

#messages-container {
    scroll-behavior: smooth;
}

#typing-indicator {
    font-style: italic;
    color: #6c757d;
}
</style>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    const currentUserId = {{ current_user.id }};
    const otherUserId = {{ other_user.id }};
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const typingIndicator = document.getElementById('typing-indicator');
    
    // Scroll to bottom on load
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    scrollToBottom();
    
    // Join conversation room
    socket.emit('join_conversation', {
        user_id: currentUserId,
        other_user_id: otherUserId
    });
    
    // Handle message form submission
    messageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const content = messageInput.value.trim();
        if (!content) return;
        
        // Send message via API
        fetch('/api/messages/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                receiver_id: otherUserId,
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageInput.value = '';
                // Message will be added via SocketIO event
            } else {
                alert('Failed to send message: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to send message');
        });
    });
    
    // Listen for new messages
    socket.on('new_message', (data) => {
        // Show browser notification if this is a new message (not from current user)
        if (data.sender_id !== currentUserId && 'Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification('New Message', {
                body: data.content.substring(0, 100),
                icon: '/static/images/logo.png',
                tag: 'chat-message-' + data.id
            });
            setTimeout(() => notification.close(), 5000);
        }
        if (data.sender_id === otherUserId || data.sender_id === currentUserId) {
            addMessageToUI(data);
            scrollToBottom();
            
            // Mark as read if it's from the other user
            if (data.sender_id === otherUserId && !data.is_read) {
                socket.emit('mark_as_read', {
                    message_id: data.id,
                    user_id: currentUserId
                });
            }
        }
    });
    
    // Listen for typing indicators
    let typingTimeout;
    socket.on('user_typing', (data) => {
        if (data.user_id === otherUserId) {
            typingIndicator.style.display = 'block';
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                typingIndicator.style.display = 'none';
            }, 3000);
        }
    });
    
    // Send typing indicator
    let typingTimer;
    messageInput.addEventListener('input', () => {
        clearTimeout(typingTimer);
        socket.emit('typing', {
            user_id: currentUserId,
            other_user_id: otherUserId
        });
        
        typingTimer = setTimeout(() => {
            // Stop typing indicator after 1 second of no input
        }, 1000);
    });
    
    // Add message to UI
    function addMessageToUI(message) {
        const isOwnMessage = message.sender_id === currentUserId;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-wrapper mb-3 ${isOwnMessage ? 'text-end' : ''}`;
        
        const timestamp = new Date(message.timestamp);
        const timeStr = timestamp.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
        });
        
        let readIcon = '';
        if (isOwnMessage) {
            readIcon = message.is_read 
                ? '<i class="fas fa-check-double text-info"></i>' 
                : '<i class="fas fa-check"></i>';
        }
        
        messageDiv.innerHTML = `
            <div class="message-bubble d-inline-block p-3 rounded-3 ${isOwnMessage ? 'bg-primary text-white' : 'bg-white border'}" 
                 style="max-width: 70%;">
                <p class="mb-1">${escapeHtml(message.content)}</p>
                <small class="opacity-75">
                    ${timeStr} ${readIcon}
                </small>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Mark all messages in this conversation as read on page load
    fetch(`/api/messages/conversation/${otherUserId}/read`, {
        method: 'PUT'
    })
    .then(response => response.json())
    .then(data => {
        // Update read status in UI
        if (data.success) {
            document.querySelectorAll('.message-bubble small i.fa-check').forEach(icon => {
                icon.className = 'fas fa-check-double text-info';
            });
        }
    });
</script>
{% endblock %}
