{% extends "base.html" %}

{% block title %}AI Recommendations - BuildSmart{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">AI Recommendations</h1>
        <p class="text-gray-600">Get intelligent project recommendations and cost estimates</p>
    </div>
    
    <!-- Get New Recommendation Form -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">Get New Recommendation</h2>
        <form id="recommendationForm" class="space-y-4">
            <div>
                <label for="project_type" class="block text-sm font-medium text-gray-700 mb-1">Project Type</label>
                <select id="project_type" name="project_type" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="2_bedroom_house">2 Bedroom House</option>
                    <option value="3_bedroom_house">3 Bedroom House</option>
                    <option value="4_bedroom_house">4 Bedroom House</option>
                    <option value="office_building">Office Building</option>
                    <option value="warehouse">Warehouse</option>
                    <option value="shop">Shop/Commercial Space</option>
                    <option value="renovation">Home Renovation</option>
                    <option value="extension">House Extension</option>
                </select>
            </div>
            
            <div>
                <label for="project_description" class="block text-sm font-medium text-gray-700 mb-1">Project Description *</label>
                <textarea id="project_description" name="project_description" rows="4" required
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="Describe your construction project in detail..."></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="budget_range" class="block text-sm font-medium text-gray-700 mb-1">Budget Range (UGX)</label>
                    <select id="budget_range" name="budget_range" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">No specific budget</option>
                        <option value="5000000-10000000">5M - 10M</option>
                        <option value="10000000-25000000">10M - 25M</option>
                        <option value="25000000-50000000">25M - 50M</option>
                        <option value="50000000-100000000">50M - 100M</option>
                        <option value="100000000+">100M+</option>
                    </select>
                </div>
                
                <div>
                    <label for="timeline" class="block text-sm font-medium text-gray-700 mb-1">Timeline</label>
                    <select id="timeline" name="timeline" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">No specific timeline</option>
                        <option value="1-3_months">1-3 months</option>
                        <option value="3-6_months">3-6 months</option>
                        <option value="6-12_months">6-12 months</option>
                        <option value="12+_months">12+ months</option>
                    </select>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button type="submit" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center">
                    <i class="fas fa-magic mr-2"></i>
                    Get Recommendation
                </button>
            </div>
        </form>
    </div>
    
    <!-- Recommendations List -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">Your Recommendations</h2>
            <span class="text-sm text-gray-600">{{ recommendations.total }} total</span>
        </div>
        
        {% if recommendations.items %}
        <div class="space-y-6">
            {% for rec in recommendations.items %}
            <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">
                            {{ rec.project_type.replace('_', ' ')|title }}
                        </h3>
                        <p class="text-sm text-gray-600">{{ rec.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                    </div>
                    <div class="flex space-x-2">
                        {% if rec.is_saved %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-bookmark mr-1"></i>
                            Saved
                        </span>
                        {% endif %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            AI Generated
                        </span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <p class="text-gray-700">{{ rec.project_description[:200] }}{% if rec.project_description|length > 200 %}...{% endif %}</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-50 p-3 rounded-md">
                        <p class="text-sm font-medium text-gray-700">Estimated Cost</p>
                        <p class="text-lg font-bold text-green-600">
                            {% if rec.total_estimated_cost %}
                                UGX {{ "{:,.0f}".format(rec.total_estimated_cost) }}
                            {% else %}
                                <span class="text-gray-500">Calculating...</span>
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-md">
                        <p class="text-sm font-medium text-gray-700">Project Type</p>
                        <p class="text-lg font-semibold text-gray-900">{{ rec.project_type.replace('_', ' ')|title }}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-md">
                        <p class="text-sm font-medium text-gray-700">Status</p>
                        <p class="text-lg font-semibold text-gray-900">
                            {% if rec.is_saved %}Saved{% else %}Draft{% endif %}
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div class="flex space-x-3">
                        <button class="px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700 border border-blue-300 rounded-md hover:bg-blue-50">
                            <i class="fas fa-eye mr-1"></i>
                            View Details
                        </button>
                        
                        {% if not rec.is_saved %}
                        <button class="px-4 py-2 text-sm font-medium text-green-600 hover:text-green-700 border border-green-300 rounded-md hover:bg-green-50">
                            <i class="fas fa-bookmark mr-1"></i>
                            Save
                        </button>
                        {% endif %}
                        
                        <button class="px-4 py-2 text-sm font-medium text-purple-600 hover:text-purple-700 border border-purple-300 rounded-md hover:bg-purple-50">
                            <i class="fas fa-share mr-1"></i>
                            Share
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        {{ rec.created_at.strftime('%B %d, %Y') }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if recommendations.pages > 1 %}
        <div class="mt-8 flex justify-center">
            <nav class="flex space-x-2">
                {% if recommendations.has_prev %}
                <a href="{{ url_for('user.recommendations', page=recommendations.prev_num) }}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Previous
                </a>
                {% endif %}
                
                {% for page_num in recommendations.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != recommendations.page %}
                        <a href="{{ url_for('user.recommendations', page=page_num) }}" 
                           class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            {{ page_num }}
                        </a>
                        {% else %}
                        <span class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md">
                            {{ page_num }}
                        </span>
                        {% endif %}
                    {% else %}
                    <span class="px-3 py-2 text-sm font-medium text-gray-400">...</span>
                    {% endif %}
                {% endfor %}
                
                {% if recommendations.has_next %}
                <a href="{{ url_for('user.recommendations', page=recommendations.next_num) }}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Next
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-magic text-gray-400 text-3xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No recommendations yet</h3>
            <p class="text-gray-600 mb-6">Get your first AI-powered project recommendation above.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.getElementById('recommendationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        project_type: formData.get('project_type'),
        project_description: formData.get('project_description'),
        custom_specs: {
            budget_range: formData.get('budget_range'),
            timeline: formData.get('timeline')
        }
    };
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
    submitBtn.disabled = true;
    
    fetch('{{ url_for("user.get_recommendation") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Reload page to show new recommendation
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while generating recommendation');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});
</script>
{% endblock %}
