<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BuildSmart - Smart Construction Solutions{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-bx3M+0e2Rk3mJQb7Lk5y+g2sQ2l2T8g7kC2Q1m6c8yH1l0Xo9mFzJvE1Qv7X0bYzC0kQ9s2y7kQXl0aI7Y0h/A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    {% include 'components/navbar.html' %}
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    {% include 'components/footer.html' %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Browser Notifications Support -->
    {% if current_user.is_authenticated %}
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Request notification permission on page load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Connect to SocketIO for real-time notifications
        const notificationSocket = io();
        
        // Listen for new messages
        notificationSocket.on('new_message', function(data) {
            // Show browser notification if permission granted
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('New Message from BuildSmart', {
                    body: data.sender ? `${data.sender.username || 'Someone'}: ${data.content.substring(0, 100)}` : data.content.substring(0, 100),
                    icon: '/static/images/logo.png', // You may need to add a logo image
                    badge: '/static/images/logo.png',
                    tag: 'message-' + data.id,
                    requireInteraction: false
                });
                
                // Close notification after 5 seconds
                setTimeout(() => notification.close(), 5000);
                
                // Handle notification click
                notification.onclick = function() {
                    window.focus();
                    if (data.receiver_id === {{ current_user.id }}) {
                        window.location.href = '/messages/' + data.sender_id;
                    }
                    notification.close();
                };
            }
        });
    </script>
    {% endif %}
</body>
</html>
